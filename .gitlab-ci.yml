#
# Gitlab CI/CD : Build archive and Docker images and deploy on Openshift
#

variables:
    TRIGRAMME: test #arb @TODO : Change after when the right namespace is available
    REPLICA_ENV: 1
    
################################################################################
#    Anchors
################################################################################
# Build and push anchor
.build_and_push_docker_image: &build_and_push_docker_image
  - cd $IMAGE_DIR
  - docker build --pull --tag "$CI_REGISTRY_IMAGE/$IMAGE_NAME:latest" .
  - docker push "$CI_REGISTRY_IMAGE/$IMAGE_NAME:latest"

# Docker Authentification anchor
.docker_login: &docker_login
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

# Deployment preparation anchor
.prepare_deployment: &prepare_deployment
  - export NO_PROXY=grandlyon.fr
  - export KUBECONFIG=$KUBECONFIG_DEV
  - echo Preparing Deployment on $NAMESPACE 
  # DB deployment file
  - sed -i "s/__NAMESPACE_ENV__/$NAMESPACE_ENV/g" deployment/db-calqul.yml
  - sed -i "s/__POSTGRES_DB__/$POSTGRES_DB/g" deployment/db-calqul.yml 
  - sed -i "s/__POSTGRES_PASSWORD__/$POSTGRES_PASSWORD/g" deployment/db-calqul.yml 
  - sed -i "s/__POSTGRES_PORT__/$POSTGRES_PORT/g" deployment/db-calqul.yml 
  - sed -i "s/__POSTGRES_SERVER__/$POSTGRES_SERVER/g" deployment/db-calqul.yml 
  - sed -i "s/__POSTGRES_USER__/$POSTGRES_USER/g" deployment/db-calqul.yml 
  - sed -i "s/__POSTGRES_SCHEMA__/$POSTGRES_SCHEMA/g" deployment/db-calqul.yml 
  # Job deployment file
  - sed -i "s/__NAMESPACE_ENV__/$NAMESPACE_ENV/g" deployment/job-calqul.yml

# Applying openshift conf anchor
.apply_confs: &apply_confs
  # Db
  # - oc apply -f deployment/configmap.yml
  - oc apply -f deployment/db-calqul.yml
  # - oc apply -f deployment/services.yml
  # - oc apply -f deployment/routes.yml
  # Job
  - oc delete jobs --selector job-name=calqul-$NAMESPACE_ENV 
  - oc create -f deployment/job-calqul.yml

################################################################################
#    CI/CD Stages
################################################################################
stages:
  - Build Calqul
  - Deploy Calqul

# *********************************************************************************************
# * BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD BUILD *
# *********************************************************************************************

Build Calqul Python:
  stage: Build Calqul
  variables:
    DOCKER_TLS_CERTDIR: ""
    NAMESPACE_ENV: "d01"
    IMAGE_NAME: calqul-python-$NAMESPACE_ENV
    IMAGE_DIR: ./Dockerfiles/python
  rules:
    - if: $CI_COMMIT_BRANCH == "postgres-dockerfile"
    - changes: # build image only if sources have changed. 
      - ./Dockerfiles/python/Dockerfile # Image definition has changed 
  services:
    - docker:dind
  script:
    - *docker_login
    - *build_and_push_docker_image
  tags:
    - build-push-to-registry


Build Calqul Postgis:
  stage: Build Calqul
  variables:
    DOCKER_TLS_CERTDIR: ""
    NAMESPACE_ENV: "d01"
    IMAGE_NAME: calqul-db-$NAMESPACE_ENV
    IMAGE_DIR: ./Dockerfiles/db
  rules:
    - if: $CI_COMMIT_BRANCH == "postgres-dockerfile"
    - changes: # build image only if sources have changed. 
      - ./Dockerfiles/db/Dockerfile # Image definition has changed 
  services:
    - docker:dind
  script:
    - *docker_login
    - *build_and_push_docker_image
  tags:
    - build-push-to-registry

# *********************************************************************************************
# * DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLOY DEPLO *
# *********************************************************************************************

Deploy Calqul:
  stage: Deploy Calqul
  rules:
    - if: $CI_COMMIT_BRANCH == "postgres-dockerfile"
    - changes:
      - ./deployment/* # Deployment definition has changed
  variables:
    NAMESPACE_ENV: 'd01'
    NAMESPACE: "ns-$TRIGRAMME-$NAMESPACE_ENV"
  before_script:
    - *prepare_deployment
  script:
   - *apply_confs
  tags:
    #- ns-arb-d01 @TODO : Change after when the right namespace is available  
    - ns-test-d01